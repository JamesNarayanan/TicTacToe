<html>
	<head>
		<title>TicTacToe</title>
		<style>
			body {
				display: flex;
				justify-content: center;
				align-items: center;
			}
			#myCanvas {
				box-shadow: 0 0 5px 2px #aaa;
			}
		</style>
	</head>
	<body>
		<canvas id="myCanvas" width="600" height="600"></canvas>

		<script>
			var canvas = document.getElementById("myCanvas");
			var ctx = canvas.getContext("2d");

			var width = canvas.width;
			var height = canvas.height;

			var tileSize = width/3;
			var tiles = [];
			for(var c = 0; c < 3; c++) {
				tiles[c] = [];
				for(var r = 0; r < 3; r++) {
					tiles[c][r] = { x: tileSize*c, y: tileSize*r, status: 0, color: (c+r)%2==0 ? "red" : "blue" };
				}
			}

			var waitFrame = {
				x: (tileSize*3 - (tileSize*2)) / 2,
				y: (tileSize*3 - (tileSize*1.25)) / 2,
				width: tileSize*2,
				height: tileSize*1.25
			}
			
			var button = {
				x: waitFrame.x + (waitFrame.width - (waitFrame.width - 20)) / 2,
				y: waitFrame.y + waitFrame.height - (waitFrame.height / 4) - 10,
				width: waitFrame.width - 20,
				height: waitFrame.height / 4
			};

			var imgX = new Image();
			imgX.src = "x.svg";
			var imgO = new Image();
			imgO.src = "o.svg";

			var turn = "x";
			var winTurn;

			var gameState = "play";

			var fontSize = 24;
			var fontSizeUnit = "pt";
			var fontFamily = " Courier";

			function drawTiles() {
				for(var c = 0; c < 3; c++) {
					for(var r = 0; r < 3; r++) {
						var tile = tiles[c][r];
						ctx.beginPath();
						ctx.rect(tile.x, tile.y, tileSize, tileSize);
						ctx.fillStyle = tile.color;
						ctx.fill();
						ctx.closePath();
					}
				}
			}
			function drawShapes() {
				for(var c = 0; c < 3; c++) {
					for(var r = 0; r < 3; r++) {
						var tile = tiles[c][r];
						if(tile.status != 0) {
							ctx.beginPath();
							ctx.drawImage(tile.status == "x" ? imgX : imgO, tile.x, tile.y);
							ctx.closePath();
						}
					}
				}
			}
			function draw() {
				drawTiles();
				drawShapes();
				check();
			}

			function check() {
				// Check for wins
				var allGood;
				var turnToCheck;
				for(var col of tiles) { // Vertical wins
					allGood = true;
					turnToCheck = col[0].status;
					if(turnToCheck == 0)
						continue;
					for(var tile of col) {
						if(tile.status != turnToCheck)
							allGood = false;
					}
					if(allGood) {
						winTurn = turnToCheck;
						wait(true);
						return;
					}
				}
				for(var i = 0; i < 3; i++) { // Horizontal wins
					allGood = true;
					turnToCheck = tiles[0][i].status;
					if(turnToCheck == 0)
						continue;
					for(var tile of getRow(tiles, i)) {
						if(tile.status != turnToCheck)
							allGood = false;
					}
					if(allGood) {
						winTurn = turnToCheck;
						wait(true);
						return;
					}
				}

				allGood = true;
				turnToCheck = tiles[0][0].status;
				if(turnToCheck != 0) { // Top left to bottom right win
					for(var i = 0; i < 3; i++) {
						if(tiles[i][i].status != turnToCheck)
							allGood = false;
					}
					if(allGood) {
						winTurn = turnToCheck;
						wait(true);
						return;
					}
				}

				allGood = true;
				turnToCheck = tiles[0][2].status;
				if(turnToCheck != 0) { // Bottom left to top right win
					for(var c = 0, r = 2; c < 3; c++, r--) {
						if(tiles[c][r].status != turnToCheck)
							allGood = false;
					}
					if(allGood) {
						winTurn = turnToCheck;
						wait(true);
						return;
					}
				}

				// Check for ties
				var allFull = true;
				for(var col of tiles) {
					for(var tile of col) {
						if(tile.status == 0) {
							allFull = false;
							break;
						}
					}
					if(!allFull)
						break;
				}
				if(allFull) {
					wait(false);
					return;
				}
			}
			function getRow(matrix, r){
				var row = [];
				for(var i = 0; i < matrix.length; i++){
					row.push(matrix[i][r]);
				}
				return row;
			}
			function wait(win) {
				gameState = win ? "win" : "tie";

				if(win)
					console.log("Player " + winTurn + " wins!");
				else
					console.log("It's a tie");

				setTimeout(() => {
						waitDisplay();
					}, 500);
			}
			function waitDisplay() {
				ctx.beginPath();
					ctx.rect(waitFrame.x, waitFrame.y, waitFrame.width, waitFrame.height);
					ctx.fillStyle = "white";
					ctx.fill();
					ctx.strokeStyle = `2px solid black`;
					ctx.stroke();
				ctx.closePath();

				ctx.beginPath();
					ctx.font = fontSize + fontSizeUnit + fontFamily;
					ctx.fillStyle = "black";
					ctx.textAlign = "center";
					ctx.textBaseline = "middle";
					var text = gameState == "win" ? `Player ${winTurn} won!` : "It's a Tie :(";
					ctx.fillText(text, waitFrame.x + waitFrame.width/2, waitFrame.y + (waitFrame.height - button.height)/2);
				ctx.closePath();

				ctx.beginPath();
					ctx.rect(button.x, button.y, button.width, button.height);	
					ctx.fillStyle = tiles[0][0].color;
					ctx.fill();
				ctx.closePath();

				ctx.beginPath();
					ctx.font = (fontSize*.75) + fontSizeUnit + fontFamily;
					ctx.fillStyle = "white";
					ctx.textAlign = "center";
					ctx.textBaseline = "middle";
					ctx.fillText("Play Again", button.x + button.width/2, button.y + button.height/2);
				ctx.closePath();
			}

			function reset() {
				for(var c = 0; c < 3; c++) {
					tiles[c] = [];
					for(var r = 0; r < 3; r++) {
						tiles[c][r] = { x: tileSize*c, y: tileSize*r, status: 0, color: (c+r)%2==0 ? "red" : "blue" };
					}
				}
				draw();
			}

			document.addEventListener("mousedown", function handleClick(e) {
				var relativeX = e.clientX - canvas.offsetLeft;
				var relativeY = e.clientY - canvas.offsetTop;

				if(gameState == "play"){
					var tileCol = Math.floor(relativeX/tileSize);
					var tileRow = Math.floor(relativeY/tileSize);

					if(tiles[tileCol][tileRow].status == 0) {
						tiles[tileCol][tileRow].status = turn;
						turn = turn == "x" ? "o" : "x";
						draw();
					}
				}
				else {
					if(relativeX >= button.x && relativeX <= button.x + button.width && relativeY >= button.y && relativeY <= button.y + button.height) {
						gameState = "play";
						reset();
					}
				}
			}, false);

			document.addEventListener("keypress", function handleKeyPress(e) {
				var key = e.key;
				switch(parseInt(key)) {
					case 1:
						if(tiles[0][2].status == 0)
							tiles[0][2].status = turn;
						break;
					case 2:
						if(tiles[1][2].status == 0)
							tiles[1][2].status = turn;
						break;
					case 3:
						if(tiles[2][2].status == 0)
							tiles[2][2].status = turn;
						break;
					case 4:
						if(tiles[0][1].status == 0)
							tiles[0][1].status = turn;
						break;
					case 5:
						if(tiles[1][1].status == 0)
							tiles[1][1].status = turn;
						break;
					case 6:
						if(tiles[2][1].status == 0)
							tiles[2][1].status = turn;
						break;
					case 7:
						if(tiles[0][0].status == 0)
							tiles[0][0].status = turn;
						break;
					case 8:
						if(tiles[1][0].status == 0)
							tiles[1][0].status = turn;
						break;
					case 9:
						if(tiles[2][0].status == 0)
							tiles[2][0].status = turn;
						break;
				}
				if(i>=1 && i<=9) {
					draw();
					turn = turn == "x" ? "o" : "x";
				}
			}, false);

			draw();
		</script>
	</body>
</html>